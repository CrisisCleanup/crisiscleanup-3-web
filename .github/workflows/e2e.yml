name: Cypress

on:
  push:
    paths:
      - '**/**.js'
      - '**/**.vue'
      - '**/**.js.snap'
      - '.github/workflows/e2e.yml'

env:
  VUE_APP_WHAT_3_WORDS_API_KEY: ${{ secrets.VUE_APP_WHAT_3_WORDS_API_KEY }}
  VUE_APP_GOOGLE_MAPS_API_KEY: ${{ secrets.VUE_APP_GOOGLE_MAPS_API_KEY }}
  VUE_APP_PITNEYBOWES_API_KEY: ${{ secrets.VUE_APP_PITNEYBOWES_API_KEY }}
  VUE_APP_PITNEYBOWES_BASIC_AUTH_TOKEN: ${{ secrets.VUE_APP_PITNEYBOWES_BASIC_AUTH_TOKEN }}
  VUE_APP_API_BASE_URL: 'https://api.staging.crisiscleanup.io'

jobs:
  cypress:
    name: Run Visual Tests
    runs-on: ubuntu-16.04

    steps:
      - uses: actions/checkout@v2

      - name: Checkout Api
        uses: actions/checkout@v2
        with:
          repository: 'CrisisCleanup/crisiscleanup-3-api'
          path: 'cc3api'
          token: ${{ secrets.GITHUB_PAT }}

      - name: Spin up Api
        run: |
          echo ${{ secrets.GITHUB_PAT }} | docker login docker.pkg.github.com -u ${{ secrets.GITHUB_PAT_USER }} --password-stdin
          cd "$GITHUB_WORKSPACE/cc3api"
          docker-compose build --pull
          docker-compose up -d app

      - name: Install Dependencies
        uses: cypress-io/github-action@v1.23.1
        with:
          # will install node deps & cypress
          runTests: false

      - name: Patch Cypress Director
        env:
          SORRY_CYP_API_URL: ${{ secrets.SORRY_CYP_API_URL }}
        run: yarn cy:patch

      - name: Run Cypress
        uses: cypress-io/github-action@v1.23.1
        with:
          # skip install now
          install: false
          record: true
          start: yarn serve
          wait-on: 'http://localhost:8080'
          wait-on-timeout: 120
          browser: chrome
          headless: true
          cache-key: yarn-${{ hashFiles('**/yarn.lock') }}
          command-prefix: 'percy exec -- npx'
          env: WEB_USER=${{ secrets.CYPRESS_WEB_USER }},WEB_PASS=${{ secrets.CYPRESS_WEB_PASS }},API_URL=http://localhost:5000
        env:
          VUE_APP_API_BASE_URL: 'http://localhost:5000'
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          CYPRESS_WEB_USER: ${{ secrets.CYPRESS_WEB_USER }}
          CYPRESS_WEB_PASS: ${{ secrets.CYPRESS_WEB_PASS }}
          CYPRESS_API_URL: 'http://localhost:5000'
          SORRY_CYP_API_URL: ${{ secrets.SORRY_CYP_API_URL }}
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
