<template>
  <TitledCard
    :loading="!agentMetricsReady"
    :title="$t('phoneDashboard.leaderboard')"
    class="h-auto leaderboard__card"
    :style="{ height: 'auto' }"
    :dropdown="dropdownProps"
    @update:dropdown="onDropdownUpdate"
  >
    <div class="card-container overflow-auto h-full">
      <div
        v-for="a in agentRankings.filter(rankFilter)"
        :key="a.agent"
        class="item relative"
      >
        <div class="item--profile">
          <div class="image">
            <Avatar
              :initials="a.user.full_name"
              :url="a.user && a.user.profilePictureUrl"
              size="xsmall"
              inner-classes="shadow"
            />
          </div>
          <div class="info pl-2">
            <div class="info--user">
              <UserDetailsTooltip
                :dark="false"
                :name-class="'text-h3 font-h3 text-crisiscleanup-dark-500 name-tooltip'"
                :user="a.user.id"
                :name-style="nameTextStyle"
              />
              <div class="flex">
                <div
                  class="flex flex-col pl-1"
                  v-for="l in getLanguageTags(a.locale || 'en-US')"
                  :key="l"
                >
                  <LanguageTag class="text-bodyxsm" :language-subtag="l" />
                </div>
              </div>
            </div>
            <div class="info--state pl-1">
              <base-text
                :style="{ lineHeight: '16px' }"
                variant="h3"
                weight="400"
                :class="`dot ${getStateFriendlyName(a.currentState).replace(
                  ' ',
                  '',
                )}`"
              >
                &#8226; {{ getStateFriendlyName(a.currentState) }}
              </base-text>
              <base-text
                :style="{ lineHeight: '16px' }"
                class="pl-2 text-crisiscleanup-dark-300 opacity-50"
                variant="h4"
                regular
              >
                {{ a.enteredTimestamp | moment('from', 'now') }}
              </base-text>
            </div>

            <div class="info--org" v-if="a.organization">
              <base-text :style="{ lineHeight: '16px' }" variant="h4" regular>
                {{ a.organization.name | truncate(28) }}
              </base-text>
            </div>
          </div>
        </div>
        <div class="item--metrics">
          <div
            class="metric"
            v-for="m in ['total_inbound', 'total_outbound', 'total_calls']"
            :key="m"
          >
            <base-text variant="h1" semi-bold>
              {{ a[m] | padStart(2, '0') }}
            </base-text>
          </div>
        </div>
      </div>
    </div>
  </TitledCard>
</template>

<script>
import { computed, reactive, ref } from 'vue';
import { useStore } from 'vuex';
import TitledCard from '@/components/cards/TitledCard.vue';
import UserDetailsTooltip from '@/components/user/DetailsTooltip.vue';
import AgentClient from '@/models/phone/AgentClient';
import LanguageTag from '@/components/tags/LanguageTag.vue';
import useUser from '@/use/user/useUser';
import Avatar from '@/components/Avatar.vue';

export default {
  // eslint-disable-next-line vue/multi-word-component-names
  name: 'Leaderboard',
  components: {
    TitledCard,
    UserDetailsTooltip,
    LanguageTag,
    Avatar,
  },
  setup(props, context) {
    const store = useStore();
    const agentRankings = computed(
      () => store.getters['phone.controller'].agentRankings,
    );
    const agentMetricsReady = computed(
      () => store.getters['phone.controller'].agentMetricsReady,
    );

    const { currentUser } = useUser();

    const rankFilter = ref((ag) => ag.currentState.includes('online'));

    const dropdownProps = reactive({
      label: 'name',
      itemKey: 'key',
      value: 'online',
      options: [
        {
          key: 'online',
          name: context.root.$t('phoneDashboard.online'),
        },
        {
          key: 'today',
          name: context.root.$t('phoneDashboard.today'),
        },
        {
          key: 'week',
          name: context.root.$t('phoneDashboard.this_week'),
        },
        {
          key: 'month',
          name: context.root.$t('phoneDashboard.this_month'),
        },
        {
          key: 'all',
          name: context.root.$t('phoneDashboard.all_time'),
        },
        {
          key: 'english',
          name: context.root.$t('phoneDashboard.english'),
        },
        {
          key: 'spanish',
          name: context.root.$t('phoneDashboard.spanish'),
        },
        {
          key: 'my-org',
          name: context.root.$t('phoneDashboard.my_organization'),
        },
      ],
    });

    const onDropdownUpdate = (value) => {
      const now = context.root.$moment();
      switch (value) {
        case 'online':
          rankFilter.value = (ag) => ag.currentState.includes('online');
          break;
        case 'my-org':
          rankFilter.value = (ag) =>
            ag.organization &&
            ag.organization.id === currentUser.value.organization.id;
          break;
        case 'today':
          rankFilter.value = (ag) =>
            context.root.$moment(ag.enteredTimestamp).isSame(now, 'day');
          break;
        case 'week':
          rankFilter.value = (ag) =>
            context.root.$moment(ag.enteredTimestamp).isSame(now, 'week');
          break;
        case 'month':
          rankFilter.value = (ag) =>
            context.root.$moment(ag.enteredTimestamp).isSame(now, 'month');
          break;
        case 'english':
          rankFilter.value = (ag) => ag.locale.includes('en');
          break;
        case 'spanish':
          rankFilter.value = (ag) => ag.locale.includes('es');
          break;
        default:
          rankFilter.value = (ag) => ag;
      }
    };

    return {
      agentRankings,
      agentMetricsReady,
      dropdownProps,
      rankFilter,
      onDropdownUpdate,
      getStateFriendlyName(state) {
        return AgentClient.getFriendlyState(state);
      },
      nameTextStyle: {
        lineHeight: '1rem',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap',
      },
      getLanguageTags(locale) {
        return locale.split('#');
      },
    };
  },
};
</script>

<style lang="scss" scoped>
$dot-colors: (
  'offline': 'red.500',
  'online': 'green.300',
  'talking': 'dark-blue',
  'paused': 'yellow.500',
  'connecting': 'teal',
);

$metric-headers: ('In' 'Out' 'Total');

@mixin truncate {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

@mixin metric-header($text) {
  content: $text;
  position: absolute;
  top: -25px;
  width: 100%;
  text-align: center;
  @apply text-crisiscleanup-dark-400 font-h4 text-h4 subpixel-antialiased;
  font-weight: 400;
  z-index: 999;
}

.metric-details {
  .right & {
    margin-bottom: -1.25rem;
  }
  align-self: flex-end;
  text-align: center;
  p {
    &:nth-child(2) {
      @apply pr-3;
    }
    &:last-child {
      font-weight: 500;
      @apply text-crisiscleanup-dark-400;
    }
    text-align: center;
  }
}

.card-container {
  display: flex;
  flex-grow: 1;
  flex-direction: column;
  max-height: 60vh;

  .item:first-of-type {
    @apply pt-3;
  }

  .item {
    &:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0.75rem;
      width: calc(100% - 0.75rem * 2);
      height: 1px;
      opacity: 0.2;
      background-color: #979797;
    }
    max-height: 91px;
    display: flex;
    align-items: baseline;
    justify-content: space-between;

    &:first-child .item--metrics {
      .metric {
        position: relative;
        &:first-child:before {
          @include metric-header('Inbound');
          left: -50%;
        }
        &:nth-child(2):before {
          @include metric-header('Return');
        }
        &:last-child:before {
          @include metric-header('Total');
          @apply text-crisiscleanup-dark-400 font-bold;
        }
      }
    }

    @apply p-2;
    &--metrics {
      display: flex;
      align-content: center;
      align-self: center;
      justify-content: space-evenly;
      flex: 1.5;
      position: relative;

      .metric p {
        color: theme('colors.crisiscleanup-dark.300');
      }
      .metric:last-child {
        p {
          color: theme('colors.crisiscleanup-dark.400');
        }
      }
    }
    &--profile {
      display: flex;
      align-items: center;
      flex: 2;
      @apply py-1;
      .image {
        border-radius: 50%;
      }
      .info {
        display: flex;
        flex-direction: column;
        &--user {
          display: flex;
          align-items: baseline;
          .v-popover .trigger p span {
            @apply text-crisiscleanup-dark-500 pr-2;
            cursor: pointer;
            @include truncate;
          }

          .user-popover p.details-name span,
          p {
            @apply text-crisiscleanup-dark-400 pr-2;
            @include truncate;
            &:last-child {
              @apply text-crisiscleanup-dark-300;
            }
          }
        }
        &--state {
          display: flex;
          flex-direction: row;
          @each $state, $color in $dot-colors {
            .dot.#{$state} {
              color: theme('colors.crisiscleanup-#{$color}');
              @include truncate;
            }
          }
          align-items: baseline;
        }
        &--org {
          p {
            @apply text-crisiscleanup-dark-300;
            @include truncate;
          }
        }
      }
    }
  }
}
</style>
